<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700&family=Noto+Sans+KR:wght@100;400&family=Playfair+Display:ital@1&display=swap"
      rel="stylesheet"
    />
    <title>투두리스트</title>
  </head>
  <body>
    <div id="container">
      <div id="card">
        <h1>Notes App</h1>
        <p>Take notes and never forget</p>
        <div class="search">
          <input type="text" class="search__input" placeholder="Search" />
          <select name="sort" class="search__select" id="sort">
            <option value="defalut">최신순</option>
            <option value="latest">수정시간순</option>
          </select>
        </div>
        <div class="back none">
          <button class="btn back__btn">&lt;&nbsp;Back</button>
          <div class="time"></div>
        </div>
        <div id="list"></div>
        <form class="note none">
          <input type="text" name="title" placeholder="Note Title" required />
          <textarea name="content" cols="30" rows="10" placeholder="Enter note text" required></textarea>
          <div class="change none">
            <button type="submit" name="action" class="btn remove">Remove Note</button>
            <button type="submit" name="action" class="btn done">Done</button>
            <button type="submit" name="action" class="btn update none">Update</button>
          </div>
        </form>
        <div class="default">
          <button type="button" class="btn create">Create Note</button>
        </div>
      </div>
    </div>
    <script>
      const $form = document.querySelector('form');

      const $backBtn = document.querySelector('.back__btn');
      const $createBtn = document.querySelector('.create');
      const $updateBtn = document.querySelector('.update');
      const $deleteBtn = document.querySelector('.remove');
      const $doneBtn = document.querySelector('.done');

      const $defaultDiv = document.querySelector('.default');
      const $listDiv = document.querySelector('#list');
      const $noResult = document.querySelector('.no-result');

      const $changeDiv = document.querySelector('.change');
      const $searchDiv = document.querySelector('.search');
      const $backDiv = document.querySelector('.back');

      let todolist = [];
      let title;
      let content;
      let cnt;
      let date = new Date();
      const TODOS_KEY = 'todos';

      const saveTodos = todos => {
        localStorage.setItem(TODOS_KEY, JSON.stringify(todos));
      };

      render();

      function render() {
        const $ul = document.createElement('ul');
        $listDiv.innerHTML = '';

        const parsedTodos = JSON.parse(localStorage.getItem(TODOS_KEY));
        todolist = parsedTodos;

        if (todolist === null) {
          saveTodos([]);
          todolist = [];
          cnt = 0;
        } else {
          cnt = todolist.length;
          console.log(`cnt: ${cnt}`);
        }

        if (todolist.length < 1) {
          const $li = document.createElement('li');
          $li.textContent = 'No Result';
          $li.className = 'no-result';
          $ul.append($li);
        } else {
          showTodosDisplay(todolist, $ul);
        }

        $listDiv.append($ul);

        console.log('투두리스트 목록표시!');
        console.log(todolist);
      }

      // 투두리스트 목록
      function showTodosDisplay(array, element) {
        array.forEach(list => {
          const $li = document.createElement('li');
          const $title = document.createElement('div');
          const $content = document.createElement('div');
          $title.textContent = `${list.title}`;
          $title.className = 'title';
          $content.textContent = `${list.content}`;
          $content.className = 'content';
          $li.append($title);
          $li.append($content);
          $li.addEventListener('click', onClickList(list));

          element.append($li);
        });
      }

      // 생성버튼
      const onClickStartBtn = () => {
        $backDiv.classList.remove('none');
        $searchDiv.classList.add('none');

        $form.classList.remove('none');

        $changeDiv.classList.remove('none');
        $defaultDiv.classList.add('none');
        $deleteBtn.disabled = true;

        $listDiv.innerHTML = '';
        console.log('생성버튼');
      };

      $createBtn.addEventListener('click', onClickStartBtn);

      // 뒤로가기
      function onClickBack() {
        $backDiv.classList.add('none');
        $searchDiv.classList.remove('none');

        $form.classList.add('none');

        $changeDiv.classList.add('none');
        $defaultDiv.classList.remove('none');

        $updateBtn.classList.add('none');
        $doneBtn.classList.remove('none');

        $form.elements[0].value = ''; // title
        $form.elements[1].value = ''; // content

        $deleteBtn.removeEventListener('click', onClickDelete);
        $updateBtn.removeEventListener('click', onClickUpdate);

        console.log('뒤로가기');
        render();
      }

      $backBtn.addEventListener('click', onClickBack);

      // 투두리스트 생성
      const onClickCreate = event => {
        event.preventDefault();
        $form.classList.add('none');
        $changeDiv.classList.add('none');
        $backDiv.classList.add('none');
        $searchDiv.classList.remove('none');
        $defaultDiv.classList.remove('none');

        const contents = {
          id: cnt,
          title: event.target.title.value,
          content: event.target.content.value,
          createdAt: date.getTime(),
          updatedAt: date.getTime(),
        };

        todolist.push(contents);
        saveTodos(todolist);

        event.target.title.value = '';
        event.target.content.value = '';
        cnt++;

        console.log('리스트 생성!');

        render();
      };

      $form.addEventListener('submit', onClickCreate);

      // 삭제
      const onClickDelete = event => {
        event.preventDefault();
        $form.classList.add('none');

        $backDiv.classList.add('none');
        $searchDiv.classList.remove('none');

        $doneBtn.classList.remove('none');
        $updateBtn.classList.add('none');

        $changeDiv.classList.add('none');
        $defaultDiv.classList.remove('none');
        // $listDiv.innerHTML = '';

        const result = todolist.filter(list => list.id !== parseInt($deleteBtn.id));

        // todolist.splice(0, todolist.length, ...result);
        console.log(result);
        saveTodos(result);

        $form.elements[0].value = ''; // title
        $form.elements[1].value = ''; // content

        $deleteBtn.removeEventListener('click', onClickDelete);
        $updateBtn.removeEventListener('click', onClickUpdate);

        console.log('삭제!');
        render();
      };

      const $div = document.createElement('div');

      // 투두리스트 상세정보
      function onClickList(list) {
        return function (event) {
          $backDiv.classList.remove('none');
          $searchDiv.classList.add('none');

          $form.classList.remove('none');

          $changeDiv.classList.remove('none');
          $defaultDiv.classList.add('none');
          $listDiv.innerHTML = '';

          $doneBtn.classList.add('none');
          $updateBtn.classList.remove('none');

          console.log(list);
          $form.title.value = list.title;
          $form.content.value = list.content;
          $deleteBtn.id = list.id;
          $updateBtn.id = list.id;

          // console.log('현재 리스트: ' + JSON.stringify(list));
          console.log('상세정보');

          $deleteBtn.disabled = false;
          $deleteBtn.addEventListener('click', onClickDelete);
          $updateBtn.addEventListener('click', onClickUpdate);
        };
      }

      // 업데이트
      const onClickUpdate = event => {
        event.preventDefault();
        $backDiv.classList.add('none');
        $searchDiv.classList.remove('none');

        $form.classList.add('none');

        $changeDiv.classList.add('none');
        $defaultDiv.classList.remove('none');

        $doneBtn.classList.remove('none');
        $updateBtn.classList.add('none');

        const id = parseInt($updateBtn.id);
        const contents = {
          ...todolist[id],
          title: $form.elements[0].value,
          content: $form.elements[1].value,
        };

        console.log(contents);
        console.log('리스트 업데이트!');
        todolist.splice(id, 1, contents);
        saveTodos(todolist);

        $form.elements[0].value = '';
        $form.elements[1].value = '';

        $updateBtn.removeEventListener('click', onClickUpdate);
        $deleteBtn.removeEventListener('click', onClickDelete);

        render();
      };

      const searchTodos = event => {
        console.log(event.target.value);
        const value = event.target.value.toLowerCase();
        const result = todolist.filter(list => list.title.includes(value));

        searchDataDisplay(result);
      };

      const searchDataDisplay = result => {
        const $ul = document.createElement('ul');
        $listDiv.innerHTML = '';
        showTodosDisplay(result, $ul);
        $listDiv.append($ul);
      };

      const $searchBar = document.getElementsByClassName('search__input');
      $searchDiv.addEventListener('input', searchTodos);
    </script>
  </body>
</html>
